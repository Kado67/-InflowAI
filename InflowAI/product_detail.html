<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <title>ÃœrÃ¼n DetayÄ± Â· Inflow Market</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
<header class="page-header-simple">ÃœrÃ¼n DetayÄ±</header>

<main class="page-main container-narrow">
  <div id="detailBox" class="info-card">YÃ¼kleniyor...</div>
</main>

<nav class="app-tabbar">
  <a href="index.html"><span>ğŸ </span>Anasayfa</a>
  <a href="sepet.html"><span>ğŸ›’</span>Sepet</a>
  <a href="hesabim.html"><span>ğŸ‘¤</span>HesabÄ±m</a>
</nav>

<script src="app.js"></script>
<script>
  const API = "https://inflowai-api.onrender.com/api";
  const params = new URLSearchParams(location.search);
  const id = params.get("id");
  const box = document.getElementById("detailBox");

  if (!id) {
    box.textContent = "GeÃ§ersiz Ã¼rÃ¼n baÄŸlantÄ±sÄ±.";
  } else {
    loadDetail();
  }

  async function loadDetail() {
    box.innerHTML = "YÃ¼kleniyor...";

    try {
      const res  = await fetch(API + "/products/" + id);
      const data = await res.json();

      if (!res.ok) {
        box.textContent = data.message || "ÃœrÃ¼n bulunamadÄ±.";
        return;
      }

      const p = data.product || data;

      box.innerHTML = `
        <div style="text-align:center;">
          <img src="${p.images?.[0] || ''}" alt="" style="width:100%; max-width:320px; border-radius:12px; margin-bottom:10px;">
        </div>
        <h2 style="margin-bottom:6px;">${p.name}</h2>
        <div style="font-size:18px; font-weight:700; margin-bottom:4px;">${p.price}â‚º</div>
        <div style="font-size:13px; color:#6b7280; margin-bottom:6px;">
          Stok: ${p.stock ?? "-"}
        </div>
        <div style="font-size:12px; color:#6b7280; margin-bottom:12px;">
          Kategori: ${p.category || "-"}
        </div>
        <button class="btn primary" onclick="addToCart('${p._id}')">Sepete Ekle</button>

        ${
          p.description
            ? `<div style="margin-top:14px; font-size:14px;">${p.description}</div>`
            : ""
        }

        <hr style="margin:18px 0; border:none; border-top:1px solid #e5e7eb;">

        <h3 style="margin-bottom:8px;">Yorumlar</h3>
        <div id="reviewsList" style="font-size:13px; margin-bottom:14px;">
          Yorumlar yÃ¼kleniyor...
        </div>

        <div id="reviewFormWrap"></div>
      `;

      loadReviews(p._id);
    } catch (e) {
      console.error(e);
      box.textContent = "Sunucuya baÄŸlanÄ±rken hata oluÅŸtu.";
    }
  }

  async function addToCart(pid) {
    if (!getToken()) {
      window.location.href = "hesabim.html?msg=login-required";
      return;
    }

    await fetch(API + "/cart/add", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        Authorization: "Bearer " + getToken(),
      },
      body: JSON.stringify({ productId: pid, quantity: 1 }),
    });

    alert("ÃœrÃ¼n sepete eklendi.");
  }

  // ğŸ”¥ YORUM LÄ°STELE
  async function loadReviews(productId) {
    const listEl = document.getElementById("reviewsList");
    const formWrap = document.getElementById("reviewFormWrap");

    // Ã–NCE LÄ°STEYÄ° Ã‡EK
    try {
      const res  = await fetch(`${API}/reviews/product/${productId}`);
      const data = await res.json();

      if (!res.ok) {
        listEl.textContent = data.message || "Yorumlar yÃ¼klenemedi.";
      } else {
        const reviews = data.reviews || data;

        if (!reviews.length) {
          listEl.textContent = "Bu Ã¼rÃ¼n iÃ§in henÃ¼z yorum yapÄ±lmamÄ±ÅŸ.";
        } else {
          let html = "";
          reviews.forEach((r) => {
            const stars = "â˜…".repeat(r.rating || 0) + "â˜†".repeat(5 - (r.rating || 0));
            const created = r.createdAt
              ? new Date(r.createdAt).toLocaleDateString("tr-TR")
              : "";
            html += `
              <div style="padding:8px 0; border-bottom:1px solid #e5e7eb;">
                <div style="font-size:12px; color:#f59e0b;">${stars}</div>
                <div style="margin-top:2px;">${r.comment || ""}</div>
                <div style="font-size:11px; color:#6b7280; margin-top:2px;">
                  ${r.user?.name || "Anonim"} Â· ${created}
                </div>
              </div>
            `;
          });
          listEl.innerHTML = html;
        }
      }
    } catch (e) {
      console.error(e);
      listEl.textContent = "Yorumlar alÄ±nÄ±rken hata oluÅŸtu.";
    }

    // SONRA FORMU HAZIRLA
    if (!getToken()) {
      formWrap.innerHTML = `
        <div class="info-card" style="padding:10px 12px;">
          Yorum yazmak iÃ§in Ã¶nce
          <a href="hesabim.html">giriÅŸ yapÄ±n</a>.
        </div>`;
      return;
    }

    formWrap.innerHTML = `
      <div class="info-card" style="padding:12px 14px;">
        <h4 style="margin-top:0; margin-bottom:8px;">Yorum Yaz</h4>
        <div class="form-row">
          <label>Puan</label>
          <select id="reviewRating">
            <option value="5">5 - Harika</option>
            <option value="4">4 - Ä°yi</option>
            <option value="3">3 - Orta</option>
            <option value="2">2 - KÃ¶tÃ¼</option>
            <option value="1">1 - Ã‡ok kÃ¶tÃ¼</option>
          </select>
        </div>
        <div class="form-row">
          <label>Yorumunuz</label>
          <textarea id="reviewComment" placeholder="ÃœrÃ¼nle ilgili deneyiminizi yazÄ±n..."></textarea>
        </div>
        <button class="btn primary" type="button" onclick="submitReview('${productId}')">
          Yorum GÃ¶nder
        </button>
        <p id="reviewMsg" class="form-message"></p>
      </div>
    `;
  }

  // ğŸ”¥ YORUM GÃ–NDER
  async function submitReview(productId) {
    const ratingEl  = document.getElementById("reviewRating");
    const commentEl = document.getElementById("reviewComment");
    const msgEl     = document.getElementById("reviewMsg");

    const rating  = parseInt(ratingEl.value || "5", 10);
    const comment = commentEl.value.trim();

    if (!comment) {
      msgEl.textContent = "LÃ¼tfen bir yorum yazÄ±n.";
      msgEl.style.color = "#b91c1c";
      return;
    }

    msgEl.textContent = "GÃ¶nderiliyor...";

    try {
      const res = await fetch(`${API}/reviews`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          Authorization: "Bearer " + getToken(),
        },
        body: JSON.stringify({
          productId,
          rating,
          comment,
        }),
      });

      const data = await res.json();

      if (!res.ok) {
        msgEl.textContent = data.message || "Yorum kaydedilemedi.";
        msgEl.style.color = "#b91c1c";
        return;
      }

      msgEl.textContent = "Yorumunuz kaydedildi.";
      msgEl.style.color = "#16a34a";
      commentEl.value = "";

      // Listeyi yeniden yÃ¼kle
      loadReviews(productId);
    } catch (e) {
      console.error(e);
      msgEl.textContent = "Sunucuya baÄŸlanÄ±rken hata oluÅŸtu.";
      msgEl.style.color = "#b91c1c";
    }
  }
</script>
</body>
</html>
